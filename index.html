<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Asteroids v1 â€” Three.js</title>
    <link rel="preconnect" href="https://unpkg.com" />
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.158.0/build/three.module.js"
        }
      }
    </script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="status" role="status" aria-live="polite" data-show="1">
      <div id="statusLine">Bootingâ€¦</div>
      <pre id="statusLog"></pre>
    </div>
    <script>
      // Lightweight status overlay + global error handlers
      (function(){
        const line = document.getElementById('statusLine');
        const logEl = document.getElementById('statusLog');
        const api = {
          set(msg){ line.textContent = msg; },
          log(msg){ if(!msg) return; const t = new Date().toISOString().split('T')[1].slice(0,12); logEl.textContent += `[${t}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; },
          show(){ document.getElementById('status').dataset.show = '1'; },
          hide(){ document.getElementById('status').dataset.show = '0'; },
          toggle(){ const e=document.getElementById('status'); e.dataset.show = e.dataset.show === '1' ? '0':'1'; }
        };
        window.__status = api;
        api.set('Loading modulesâ€¦');
        window.addEventListener('error', (e)=>{
          api.set('Error: ' + (e && e.message || 'Unknown error'));
          api.log((e && e.error && e.error.stack) || String(e.message || e));
          window.__gameBoot = 'error';
        });
        window.addEventListener('unhandledrejection', (e)=>{
          api.set('Unhandled promise rejection');
          api.log(String(e.reason && (e.reason.stack || e.reason.message) || e.reason || e));
          window.__gameBoot = 'error';
        });
        window.addEventListener('keydown', (e)=>{ if(e.key==='F1' || e.key==='`'){ e.preventDefault(); api.toggle(); }});
      })();
    </script>
    <div id="hud">
      <div id="score">Score: 0</div>
      <div id="wave">Wave: 1</div>
      <div id="combo" style="opacity:.8">Combo: 1x</div>
      <div id="hint">W/A/D to move, Space to shoot. R to restart. Press M for Mouse Mode (Lock: M, Release: Esc/M; LMB shoot, RMB thrust).</div>
      <div id="audio">
        <label for="sfxVol">SFX</label>
        <input id="sfxVol" type="range" min="0" max="100" value="80" />
        <button id="sfxMute" type="button">Mute</button>
      </div>
    </div>
    <!-- Currencies HUD -->
    <div id="currencies">
      <span class="c salvage" title="Salvage">â›­ <b id="salvageCount">0</b></span>
      <span class="c gold" title="Gold">â—† <b id="goldCount">0</b></span>
      <span class="c platinum" title="Platinum">â—ˆ <b id="platCount">0</b></span>
      <span class="c adam" title="Adamantium">â¬¢ <b id="adamCount">0</b></span>
    </div>
    <!-- Taken upgrades stack -->
    <div id="taken"></div>
    <div id="gameover" hidden>
      <h1>Game Over</h1>
      <p id="finalScore"></p>
      <p id="deathReason"></p>
      <p>Press R to restart</p>
    </div>

    <div id="choices" hidden>
      <div class="heading">
        <h1>UPGRADE</h1>
        <p>Choose one to power up</p>
      </div>
      <div class="cards" id="choiceCards"></div>
    </div>
    <!-- Mouse-mode reticle -->
    <div id="reticle" hidden></div>
    <div id="frameCounter">0</div>
    <button id="toggleLog" title="Toggle Log">Log</button>
    <!-- End screen overlay -->
    <div id="endOverlay" class="overlay" hidden>
      <img src="assets/gameEnd.png" alt="Game Over" class="overlay-img"/>
      <div class="overlay-center">
        <h1>Run Over</h1>
        <p id="endStats"></p>
        <p id="endDeathReason" style="color: #ff6b6b; margin: 10px 0; font-size: 1.1em;"></p>
        <p>Press R to restart</p>
      </div>
    </div>

    <!-- Start screen overlay -->
    <div id="startOverlay" class="overlay show">
      <img src="assets/start_screen.png" alt="Start Screen" class="overlay-img"/>
      <div class="overlay-center">
        <h1>Asteroids Roguelite</h1>
        <p>Click to start â€¢ WASD/Mouse â€¢ Space to shoot â€¢ R to restart</p>
      </div>
    </div>

    <!-- Hangar Shop overlay -->
    <div id="hangar" class="overlay" hidden>
      <img src="assets/Hanger.png" alt="Hangar Background" class="overlay-img"/>
      <div class="overlay-center">
        <h1>HANGAR</h1>
        <p>Spend salvage and ores to upgrade</p>
      </div>
      
      <!-- Moved cards higher up -->
      <div id="shopCards" class="choices choices-3d" aria-live="polite" style="position:absolute; top:30%; left:50%; transform:translateX(-50%); z-index:10003;"></div>
      <div id="choicesMouseLayer" aria-hidden="true"></div>
      
      <!-- Currency Display moved below cards -->
      <div id="hangarCurrency" style="position:absolute; top:65%; left:50%; transform:translateX(-50%); z-index:10003; display:flex; gap:24px; font-size:20px; font-weight:bold; text-shadow:0 0 12px rgba(140,170,255,0.6);">
        <span class="c salvage" title="Salvage" style="color:#bde2ff;">â›­ <span id="hangarSalvage">0</span></span>
        <span class="c gold" title="Gold" style="color:#ffd77a;">â—† <span id="hangarGold">0</span></span>
        <span class="c platinum" title="Platinum" style="color:#d8f4ff;">â—ˆ <span id="hangarPlatinum">0</span></span>
        <span class="c adam" title="Adamantium" style="color:#ff9a7a;">â¬¢ <span id="hangarAdamantium">0</span></span>
      </div>
      
      <div class="shop-row" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); display:flex; gap:10px;">
        <button id="rerollShop">Reroll (ðŸŸ¦ <span id="rerollCost">15</span>)</button>
        <button id="banishOne">Banish 1 (free)</button>
        <button id="toggleVis">High-Vis Bullets</button>
        <button id="nextMission" style="background: linear-gradient(45deg, #4a90e2, #357abd); border: 2px solid #5ba3ff; font-weight: bold; font-size: 16px; padding: 10px 20px;">Next Mission</button>
        <button id="leaveHangar">Launch</button>
      </div>
      <p id="shopInfo" class="sub" style="position:absolute; bottom:14px; left:50%; transform:translateX(-50%);">Epics unlock after Wave 5 or when you own prerequisites.</p>
    </div>
    <div id="copyright">Â© 2025 Snootypants. All rights reserved.</div>
    <script type="module" src="src/main.js"></script>
    <script>
      // Simple loader diagnostic: if the module didn't set the flag,
      // show a message and hint to check DevTools or network.
      setTimeout(() => {
        if (window.__gameBoot !== 'running') {
          console.warn('[Asteroids] Module did not boot. Check DevTools > Console for import errors.');
          const msg = document.createElement('div');
          msg.style.position = 'fixed';
          msg.style.bottom = '10px';
          msg.style.right = '10px';
          msg.style.padding = '10px 12px';
          msg.style.border = '1px solid rgba(255,120,120,0.4)';
          msg.style.background = 'rgba(30,10,10,0.7)';
          msg.style.color = '#ffdada';
          msg.style.zIndex = '99999';
          msg.textContent = 'Game failed to start. Open DevTools > Console and share the red error lines.';
          document.body.appendChild(msg);
          if (window.__status) { window.__status.set('Module did not boot'); window.__status.show(); }
        }
      }, 800);
    </script>
  </body>
  </html>
